general:
    artifacts:
      - "/mnt/gentoo/usr/portage/packages"
dependencies:
    pre:
      - sudo mkdir /mnt/gentoo
      - bash fetch_stage3.sh
      - cd /mnt/gentoo; sudo patch -p0 < ~/$CIRCLE_PROJECT_REPONAME/emerge.patch
      - sudo mount -t proc /proc /mnt/gentoo/proc
      - sudo mount -t tmpfs tmps /mnt/gentoo/var/tmp
      - sudo mount -t tmpfs tmps /mnt/gentoo/var/cache
      - sudo mount -t tmpfs tmps /mnt/gentoo/usr/portage
      - sudo touch /mnt/gentoo/dev/null
      - sudo chmod 0777 /mnt/gentoo/dev/null
      - sudo dd if=/dev/urandom of=/mnt/gentoo/dev/urandom count=512
      - sudo dd if=/dev/random of=/mnt/gentoo/dev/random count=512
      - sudo sudo mkdir /mnt/gentoo/dev/shm
      - sudo mount -t tmpfs -o nosuid,nodev,noexec shm /mnt/gentoo/dev/shm
      - sudo rsync -vrtza ~/${CIRCLE_PROJECT_REPONAME}/files/ /mnt/gentoo/
      - sudo echo "nameserver 8.8.8.8" > /mnt/gentoo/etc/resolv.conf
      - sudo chroot /mnt/gentoo /bin/bash emerge-webrsync
test:
    override:
      - sudo chroot /mnt/gentoo emerge -q =sys-kernel/gentoo-sources-4.9.16
      # - sudo chroot /mnt/gentoo /bin/bash -c "cd /usr/src/linux-4.9.16-gentoo; wget https://raw.githubusercontent.com/pgrandin/kernel-configs/master/MacBookPro2015 -O .config"
      # - sudo chroot /mnt/gentoo/ /bin/bash -c "cd /usr/src/linux-4.9.8-gentoo; make -j24 && make modules_install && make install"
      # The following packages fail to build with parallel builds, so this is a workaround
      - sudo chroot /mnt/gentoo /usr/bin/env emerge -qo llvm
      - sudo chroot /mnt/gentoo /usr/bin/env emerge -1 llvm
      - sudo chroot /mnt/gentoo /usr/bin/env emerge -qo cmake media-libs/mesa dev-libs/boost
      - sudo chroot /mnt/gentoo /usr/bin/env MAKEOPTS="-j1" emerge -1 cmake media-libs/mesa dev-libs/boost
      # Essentials
      - sudo chroot /mnt/gentoo emerge -q app-editors/vim app-misc/tmux
      - sudo chroot /mnt/gentoo emerge -q net-wireless/wpa_supplicant net-wireless/wireless-tools
      - sudo chroot /mnt/gentoo emerge -q net-wireless/bluez net-wireless/rfkill
      - sudo chroot /mnt/gentoo emerge -q media-sound/alsa-utils
      # X and i3
      - sudo chroot /mnt/gentoo emerge -q x11-wm/i3 x11-misc/i3lock media-gfx/feh
      # x11-misc/i3status will fail because of Setting caps 'cap_net_admin=ep' on file '/usr/bin/i3status'
      - sudo chroot /mnt/gentoo emerge -q x11-misc/slim
      - sudo chroot /mnt/gentoo emerge -q app-pda/libimobiledevice app-pda/usbmuxd
      - sudo chroot /mnt/gentoo emerge -1 x11-libs/libXv
      - sudo chroot /mnt/gentoo emerge -qo media-tv/kodi
      - sudo chroot /mnt/gentoo emerge media-tv/kodi
      - sudo chroot /mnt/gentoo emerge -q x11-base/xorg-server
      # Cleanup and pack
      - sudo rm /mnt/gentoo/etc/resolv.conf
      - sudo tar cvfz ${CIRCLE_ARTIFACTS}/gentoo-${CIRCLE_BRANCH}-stage4-${CIRCLE_BUILD_NUM}.tgz --one-file-system /mnt/gentoo
notify:
    webhooks:
      - url: http://sd-55475.dedibox.fr:8000/
